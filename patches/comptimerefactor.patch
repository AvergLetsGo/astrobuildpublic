From 9bfc82a14b95638bb51aaf6d8cbf7bd840178575 Mon Sep 17 00:00:00 2001
From: GoldenTails <milestailsprower101n2@gmail.com>
Date: Sun, 27 Mar 2022 20:14:54 -0500
Subject: [PATCH 1/3] Prevent comptime.* from failing compilation

---
 src/Makefile | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/Makefile b/src/Makefile
index c1aa35742..e24d301bc 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -357,9 +357,9 @@ $(dbg).txt : $(dbg)
 # this really updates comptime.h
 comptime.c ::
 ifdef WINDOWSHELL
-	$(.)..\comptime.bat .
+	-$(.)..\comptime.bat .
 else
-	$(.)../comptime.sh .
+	-$(.)../comptime.sh .
 endif
 
 # I wish I could make dependencies out of rc files :(
-- 
GitLab


From a614865d3592ef7aed3c0c2d570aea8c6e508ea3 Mon Sep 17 00:00:00 2001
From: GoldenTails <milestailsprower101n2@gmail.com>
Date: Sun, 27 Mar 2022 21:16:07 -0500
Subject: [PATCH 2/3] Make comptime.sh conform to POSIX and less redundant,
 among other improvements

- Shebang now directly calls /bin/sh
- Improved indenting within the comprevision() function
- Quoted several strings to prevent possible argument splitting
- Replaced archaic backtick command statements with more descriptive `"$(...)"` statements
- Replaced direct references to `test` with more readable, but equivalent `[ ... ]` statements
- Replaced the ${str:0:8} bashism with an equivalent statement using POSIX cut
- Moved redundant definitions of the comptime.h body to a single function that takes arguments
---
 comptime.sh | 54 ++++++++++++++++++++++-------------------------------
 1 file changed, 22 insertions(+), 32 deletions(-)

diff --git a/comptime.sh b/comptime.sh
index d5ef7271a..a619f6a1a 100755
--- a/comptime.sh
+++ b/comptime.sh
@@ -1,54 +1,44 @@
-#!/bin/bash -e
+#!/bin/sh
 path="."
 if [ x"$1" != x ]; then
 	path="$1"
 fi
 
-versiongit() {
-	gitbranch=`git rev-parse --abbrev-ref HEAD`
-	gitversion=`git rev-parse HEAD`
-	cat <<EOF > $path/comptime.h
+version() {
+	cat <<EOF > "$path/comptime.h"
 
 // Do not edit!  This file was autogenerated
 // by the $0 script with git
 //
-const char* compbranch = "$gitbranch";
-const char* comprevision = "${gitversion:0:8}";
+const char* compbranch = "$1";
+const char* comprevision = "$2";
 EOF
-exit 0
 }
 
-versionsvn() {
-	svnrevision=`svnversion -n $1`
-	cat <<EOF > $path/comptime.h
+versiongit() {
+	gitbranch="$(git rev-parse --abbrev-ref HEAD)"
+	gitversion="$(git rev-parse HEAD | cut -c -8)"
+	version "$gitbranch" "$gitversion";
+	exit 0
+}
 
-// Do not edit!  This file was autogenerated
-// by the $0 script with subversion
-//
-const char* compbranch = "Subversion";
-const char* comprevision = "r$svnrevision";
-EOF
-exit 0
+versionsvn() {
+	svnrevision="$(svnversion -n $1)"
+	version "Subversion" "r$svnrevision";
+	exit 0
 }
 
 versionfake() {
-	cat <<EOF > $path/comptime.h
-
-// Do not edit!  This file was autogenerated
-// by the $0 script with an unknown or nonexist SCM
-//
-const char* compbranch = "Unknown";
-const char* comprevision = "illegal";
-EOF
+	version "Unknown" "illegal";
 }
 
 compversion() {
-touch $path/comptime.c
-versionfake
-test -d $path/.svn && versionsvn
-test -d $path/../.git && versiongit
-exit 1
+	touch "$path/comptime.c"
+	versionfake
+	[ -d "$path/.svn" ] && versionsvn
+	[ -d "$path/../.git" ] && versiongit
+	exit 1
 }
 
-test -f $path/comptime.c && compversion
+[ -f "$path/comptime.c" ] && compversion
 exit 2
-- 
GitLab


From b7711b2b97ea33b8f8ceb2e5fde791da725dd067 Mon Sep 17 00:00:00 2001
From: GoldenTails <milestailsprower101n2@gmail.com>
Date: Sun, 27 Mar 2022 21:23:32 -0500
Subject: [PATCH 3/3] Pass argument list directly to functions that use them;
 quote arguments when used.

---
 comptime.sh | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/comptime.sh b/comptime.sh
index a619f6a1a..ce771f631 100755
--- a/comptime.sh
+++ b/comptime.sh
@@ -23,7 +23,7 @@ versiongit() {
 }
 
 versionsvn() {
-	svnrevision="$(svnversion -n $1)"
+	svnrevision="$(svnversion -n "$1")"
 	version "Subversion" "r$svnrevision";
 	exit 0
 }
@@ -35,10 +35,10 @@ versionfake() {
 compversion() {
 	touch "$path/comptime.c"
 	versionfake
-	[ -d "$path/.svn" ] && versionsvn
+	[ -d "$path/.svn" ] && versionsvn "$@"
 	[ -d "$path/../.git" ] && versiongit
 	exit 1
 }
 
-[ -f "$path/comptime.c" ] && compversion
+[ -f "$path/comptime.c" ] && compversion "$@"
 exit 2
-- 
GitLab

